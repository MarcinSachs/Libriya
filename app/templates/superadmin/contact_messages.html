{% extends 'base/main_base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-4">
    {% with flashes = get_flashed_messages(with_categories=true) %}
    {% if flashes %}
    {% for category, message in flashes %}
    <div class="{% if category == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif category == 'error' or category == 'danger' %}bg-red-50 border border-red-200 text-red-800{% elif category == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %} px-4 py-3 rounded-lg flex items-start gap-2 mb-4" role="alert">
        <div class="flex-1 flex items-start gap-2">
            {% if category == 'success' %}
            <i class='bx bx-check-circle mt-0.5'></i>
            {% elif category == 'danger' or category == 'error' %}
            <i class='bx bx-error-circle mt-0.5'></i>
            {% elif category == 'warning' %}
            <i class='bx bx-alert-triangle mt-0.5'></i>
            {% else %}
            <i class='bx bx-info-circle mt-0.5'></i>
            {% endif %}
            <span>{{ message }}</span>
        </div>
        <button type="button" class="text-current hover:opacity-70 transition" onclick="this.parentElement.remove()" aria-label="Close">
            <i class='bx bx-x'></i>
        </button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
    
    <h2 class="text-2xl font-bold text-gray-800">{{ _('Contact Messages') }}</h2>
    
    {% if messages %}
    <div class="space-y-4">
        {% for msg in messages %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-100 {% if not msg.read_by_admin %}bg-blue-100{% endif %} px-4 py-3 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <h5 class="font-semibold text-lg mb-0">{{ msg.subject }}</h5>
                        <small class="text-sm">
                            {{ _('From:') }} <strong>{{ msg.user.username }}</strong> 
                            ({{ msg.user.email }})
                        </small>
                        <br>
                        <small class="text-sm">
                            {{ _('Library:') }} <strong>{{ msg.library.name }}</strong>
                        </small>
                        <br>
                        <small class="text-gray-600">{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    <div>
                        {% if msg.is_resolved %}
                        <span class="inline-block bg-green-200 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Resolved') }}</span>
                        {% else %}
                        <span class="inline-block bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Open') }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="px-4 py-3">
                <div class="mb-3">
                    <p class="text-gray-600 text-sm"><small>{{ _('User Message:') }}</small></p>
                    <p>{{ msg.message | replace('\n', '<br>') | safe }}</p>
                </div>
                
                {% if msg.reply_message %}
                <hr class="my-4">
                <div class="mb-3 bg-gray-50 p-4 rounded-lg">
                    <p class="text-gray-600 text-sm"><small>
                        {{ _('Reply from:') }} <strong>{{ msg.reply_by.username }}</strong> 
                        - {{ msg.replied_at.strftime('%Y-%m-%d %H:%M') }}
                    </small></p>
                    <p>{{ msg.reply_message | replace('\n', '<br>') | safe }}</p>
                </div>
                {% endif %}
            </div>
            <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
                {% if not msg.reply_message %}
                <button class="btn btn-primary btn-sm" onclick="document.getElementById('reply-{{ msg.id }}').classList.toggle('hidden')">
                    {{ _('Reply') }}
                </button>
                {% endif %}
                {% if not msg.is_resolved %}
                <a href="{{ url_for('users.mark_message_resolved', message_id=msg.id) }}" class="btn btn-success btn-sm">
                    {{ _('Mark as Resolved') }}
                </a>
                {% endif %}
            </div>
            
            {% if not msg.reply_message %}
            <div class="hidden" id="reply-{{ msg.id }}">
                <div class="px-4 py-3 border-t border-gray-200">
                    <form method="post" action="{{ url_for('users.reply_to_message', message_id=msg.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label class="block font-medium text-gray-700 mb-2">{{ _('Your Reply') }}</label>
                            <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-[#4ecdc4] focus:ring-2 focus:ring-[#4ecdc4] focus:ring-opacity-20 transition" name="reply_message" rows="6" required 
                                style="resize: vertical; min-height: 150px;" 
                                placeholder="{{ _('Type your reply...') }}"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">{{ _('Send Reply') }}</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg">
        {{ _('No messages.') }}
    </div>
    {% endif %}
</div>
{% endblock %}
