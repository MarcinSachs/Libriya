{% extends "layout.html" %}

{% block content %}
<div class="container-fluid mt-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if not codes %}
    <div class="alert alert-info d-flex align-items-center mb-4">
        <i class='bx bxs-info-circle me-2'></i>
        <span>{{ _('No invitation codes yet.') }}</span>
    </div>
    {% endif %}

    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2>{{ _('Invitation Codes') }}</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('invitations.generate_code') }}" class="btn btn-primary add-book-btn d-inline-flex align-items-center">
                {{ _('Add code') }}
            </a>
        </div>
    </div>

    {% if codes %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>{{ _('Code') }}</th>
                    <th>{{ _('Library') }}</th>
                    <th>{{ _('Created By') }}</th>
                    <th>{{ _('Created') }}</th>
                    <th>{{ _('Expires') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Used By') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for code in codes %}
                <tr>
                    <td>
                        <code class="bg-light p-2">{{ code.code }}</code>
                    </td>
                    <td>{{ code.library.name }}</td>
                    <td>{{ code.created_by.username }}</td>
                    <td>{{ code.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if code.expires_at > now() %}
                            {{ code.expires_at.strftime('%Y-%m-%d') }}
                            <small class="text-muted">({{ (code.expires_at - now()).days }} days)</small>
                        {% else %}
                            <span class="badge bg-danger">{{ _('Expired') }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if code.is_valid() %}
                            <span class="badge bg-success">{{ _('Active') }}</span>
                        {% else %}
                            {% if code.used_by_id %}
                                <span class="badge bg-info">{{ _('Used') }}</span>
                            {% else %}
                                <span class="badge bg-secondary">-</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if code.used_by_id %}
                            {{ code.used_by.username }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary copy-code" data-code-id="{{ code.id }}" 
                                title="{{ _('Copy code to clipboard') }}">
                            <i class='bx bx-copy'></i> {{ _('Copy') }}
                        </button>
                        {% if not code.used_by_id and code.is_valid() %}
                        <form method="POST" action="{{ url_for('invitations.deactivate_code', code_id=code.id) }}" 
                              style="display: inline;" 
                              onsubmit="return confirm('{{ _('Deactivate this code?') }}')">
                            <button class="btn btn-sm btn-outline-danger" type="submit">
                                <i class='bx bx-trash'></i>
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.copy-code').forEach(btn => {
    btn.addEventListener('click', async function() {
        const codeId = this.dataset.codeId;
        const response = await fetch(`/invitation-codes/${codeId}/copy`, { method: 'POST' });
        const data = await response.json();
        
        if (data.code) {
            navigator.clipboard.writeText(data.code).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="bx bx-check"></i> {{ _("Copied") }}';
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 2000);
            });
        }
    });
});
</script>

<style>
    .copy-code {
        transition: all 0.3s;
    }
</style>
{% endblock %}
