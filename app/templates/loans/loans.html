{% extends "base/main_base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-2xl font-bold text-gray-800">{{ title }}</h2>
        {% if current_user and (current_user.role == 'admin' or current_user.role == 'manager') %}
        <a href="{{ url_for('loans.loan_add') }}" class="btn btn-primary">{{ _('Add Loan') }}
        </a>
        {% endif %}
    </div>
    <hr class="my-4">

    {{ macros.display_flashes() }}


    <!-- Filtering form -->
    <form method="GET" action="{{ url_for('loans.loans') }}" class="mb-3">
        <div class="flex flex-col md:flex-row gap-2">
            <div class="w-full md:flex-1">
                <label for="status" class="block font-medium text-gray-700 mb-2">{{ _('Loan Status') }}</label>
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-[#4ecdc4] focus:ring-2 focus:ring-[#4ecdc4] focus:ring-opacity-20 transition" id="status" name="status">
                    <option value="">{{ _('All') }}</option>
                    <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>{{
                        _('Pending Approval') }}</option>
                    <option value="active" {% if request.args.get('status')=='active' %}selected{% endif %}>{{ _('Active
                        Loan') }}</option>
                    <option value="returned" {% if request.args.get('status')=='returned' %}selected{% endif %}>{{
                        _('Returned') }}</option>
                    <option value="cancelled" {% if request.args.get('status')=='cancelled' %}selected{% endif %}>{{
                        _('Cancelled') }}</option>
                </select>
            </div>
            <div class="w-full md:flex-1">
                <label for="user" class="block font-medium text-gray-700 mb-2">{{ _('User') }}</label>
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-[#4ecdc4] focus:ring-2 focus:ring-[#4ecdc4] focus:ring-opacity-20 transition" id="user" name="user">
                    <option value="">{{ _('All Users') }}</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if request.args.get('user')==user.id|string %}selected{% endif %}>
                        {{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-full md:flex-1 flex flex-col md:flex-row items-end gap-2">
                <button type="submit" class="w-full md:flex-1 btn btn-primary">{{ _('Filter') }}</button>
                <a href="{{ url_for('loans.loans') }}" class="w-full md:flex-1 btn btn-outline">{{ _('Reset') }}</a>
            </div>
        </div>
    </form>

    <div class="overflow-x-auto bg-white rounded-lg shadow-sm border border-gray-200 loans-table-container">
        <table class="w-full">
            <thead>
                <tr class="bg-[#1a535c] text-white">
                    <th class="px-4 py-3 text-left font-semibold">{{ _('Book Title') }}</th>
                    <th class="px-4 py-3 text-left font-semibold">{{ _('User') }}</th>
                    <th class="px-4 py-3 text-left font-semibold">{{ _('Reservation Date') }}</th>
                    <th class="px-4 py-3 text-left font-semibold">{{ _('Issue Date') }}</th>
                    <th class="px-4 py-3 text-left font-semibold">{{ _('Return Date') }}</th>
                    <th class="px-4 py-3 text-left font-semibold">{{ _('Status') }}</th>
                    <th class="px-4 py-3 text-left font-semibold">{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in loans %}
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3">{{ loan.book.title }}</td>
                    <td class="px-4 py-3">{{ loan.user.username }}</td>
                    <td class="px-4 py-3">{{ loan.reservation_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="px-4 py-3">
                        {% if loan.issue_date %}
                        {{ loan.issue_date.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        <span class="text-gray-600">{{ _('Not issued yet') }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if loan.return_date %}
                        {{ loan.return_date.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        <span class="text-gray-600">{{ _('Not returned yet') }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if loan.status == 'pending' %}
                        <span class="inline-block bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Pending Approval') }}</span>
                        {% elif loan.status == 'active' %}
                        <span class="inline-block bg-green-200 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Active Loan') }}</span>
                        {% elif loan.status == 'returned' %}
                        <span class="inline-block bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Returned') }}</span>
                        {% elif loan.status == 'cancelled' %}
                        <span class="inline-block bg-red-200 text-red-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Cancelled') }}</span>
                        {% else %}
                        <span class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold">{{ loan.status.replace('_', ' ').title() }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if current_user and current_user.role == 'admin' %}
                        {% if loan.status == 'pending' %}
                        <form action="{{ url_for('loans.approve_loan', loan_id=loan.id) }}" method="POST"
                            style="display: inline-block; margin-bottom: 0.25rem;">
                            <button type="submit" class="text-accent hover:text-primary transition" title="{{ _('Approve Loan') }}"><i
                                    class="bx bx-check-circle"></i></button>
                        </form>
                        <form action="{{ url_for('loans.cancel_loan', loan_id=loan.id) }}" method="POST"
                            style="display: inline-block; margin-bottom: 0.25rem;">
                            <button type="submit" class="text-red-500 hover:text-red-700 transition" title="{{ _('Cancel Reservation') }}"><i
                                    class="bx bx-x-circle"></i></button>
                        </form>
                        {% elif loan.status == 'active' %}
                        <form action="{{ url_for('loans.return_loan', loan_id=loan.id) }}" method="POST"
                            style="display: inline-block; margin-bottom: 0.25rem;">
                            <button type="submit" class="bg-yellow-200 text-yellow-800 font-semibold text-sm px-3 py-1.5 rounded-lg hover:bg-yellow-300 transition" title="{{ _('Return Book') }}"><i
                                    class="bx bx-log-out-circle"></i></button>
                        </form>
                        {% if loan.issue_date and (now - loan.issue_date).days > 14 %}
                        <form action="{{ url_for('loans.send_overdue_reminder', loan_id=loan.id) }}" method="POST"
                            style="display: inline-block; margin-bottom: 0.25rem;">
                            <button type="submit" class="bg-red-200 text-red-800 font-semibold text-sm px-3 py-1.5 rounded-lg hover:bg-red-300 transition" title="{{ _('Send Overdue Reminder') }}"><i
                                    class="bx bx-alarm"></i></button>
                        </form>
                        {% endif %}
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Loans Grid (Mobile) -->
    <div class="loans-grid">
        {% for loan in loans %}
        <div class="loan-card">
            <div class="loan-card-body">
                <!-- Book Title -->
                <div class="loan-card-row">
                    <span class="loan-card-label">{{ _('Book') }}</span>
                    <span class="loan-card-value font-semibold">{{ loan.book.title }}</span>
                </div>

                <!-- User -->
                <div class="loan-card-row">
                    <span class="loan-card-label">{{ _('User') }}</span>
                    <span class="loan-card-value">{{ loan.user.username }}</span>
                </div>

                <!-- Dates -->
                <div class="loan-card-row">
                    <span class="loan-card-label">{{ _('Reservation') }}</span>
                    <span class="loan-card-value">{{ loan.reservation_date.strftime('%Y-%m-%d') }}</span>
                </div>

                {% if loan.issue_date %}
                <div class="loan-card-row">
                    <span class="loan-card-label">{{ _('Issue Date') }}</span>
                    <span class="loan-card-value">{{ loan.issue_date.strftime('%Y-%m-%d') }}</span>
                </div>
                {% endif %}

                {% if loan.return_date %}
                <div class="loan-card-row">
                    <span class="loan-card-label">{{ _('Return Date') }}</span>
                    <span class="loan-card-value">{{ loan.return_date.strftime('%Y-%m-%d') }}</span>
                </div>
                {% endif %}

                <!-- Status -->
                <div class="loan-card-status">
                    {% if loan.status == 'pending' %}
                    <span class="inline-block bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Pending') }}</span>
                    {% elif loan.status == 'active' %}
                    <span class="inline-block bg-green-200 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Active') }}</span>
                    {% elif loan.status == 'returned' %}
                    <span class="inline-block bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Returned') }}</span>
                    {% elif loan.status == 'cancelled' %}
                    <span class="inline-block bg-red-200 text-red-800 px-3 py-1 rounded-full text-xs font-semibold">{{ _('Cancelled') }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="loan-card-actions">
                {% if current_user and current_user.role == 'admin' %}
                    {% if loan.status == 'pending' %}
                    <form action="{{ url_for('loans.approve_loan', loan_id=loan.id) }}" method="POST" class="flex-1">
                        <button type="submit" class="loan-card-btn w-full" title="{{ _('Approve') }}">
                            <i class="bx bx-check"></i>
                        </button>
                    </form>
                    <form action="{{ url_for('loans.cancel_loan', loan_id=loan.id) }}" method="POST" class="flex-1">
                        <button type="submit" class="loan-card-btn loan-card-btn-danger w-full" title="{{ _('Cancel') }}">
                            <i class="bx bx-x"></i>
                        </button>
                    </form>
                    {% elif loan.status == 'active' %}
                    <form action="{{ url_for('loans.return_loan', loan_id=loan.id) }}" method="POST" class="flex-1">
                        <button type="submit" class="loan-card-btn w-full" title="{{ _('Return') }}">
                            <i class="bx bx-log-out"></i>
                        </button>
                    </form>
                    {% if loan.issue_date and (now - loan.issue_date).days > 14 %}
                    <form action="{{ url_for('loans.send_overdue_reminder', loan_id=loan.id) }}" method="POST" class="flex-1">
                        <button type="submit" class="loan-card-btn w-full" title="{{ _('Remind') }}">
                            <i class="bx bx-alarm"></i>
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div></div>

{% endblock %}