{% extends "layout.html" %}
{% block content %}

<div class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="book-count-card">
        <i class='bx bxs-info-circle'></i>
        <p class="mb-0">
            {% set n = books|length %}
            {{ ngettext('Library currently has %(n)s book.', 'Library currently has %(n)s books.', n, n=n) }}
        </p>
    </div>

    <h2>{{ _('List of books') }}</h2>

    <!-- Filtering form -->
    <form method="GET" action="{{ url_for('main.home') }}" class="mb-3">
        <div class="row g-2">
            <div class="col-md-3">
                <label for="title" class="form-label">{{ _('Title') }}</label>
                <input type="text" class="form-control" id="title" name="title"
                    value="{{ request.args.get('title', '') }}" placeholder="{{ _('Enter title to search') }}">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">{{ _('Status') }}</label>
                <select class="form-select" id="status" name="status">
                    <option value="">{{ _('All') }}</option>
                    <option value="available" {% if request.args.get('status')=='available' %}selected{% endif %}>{{
                        _('Available') }}</option>
                    <option value="on_loan" {% if request.args.get('status')=='on_loan' %}selected{% endif %}>{{ _('On
                        Loan/Reserved') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="genre" class="form-label">{{ _('Genre') }}</label>
                <select class="form-select" id="genre" name="genre">
                    <option value="">{{ _('All') }}</option>
                    {% for genre in genres %}
                    <option value="{{ genre.id }}" {% if request.args.get('genre')==genre.id|string %}selected{% endif
                        %}>{{ _(genre.name) }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-center buttons-container">
                <div style="height: 100%; width: 0; visibility: hidden;"></div>
                <button type="submit" class="btn btn-primary me-2">{{ _('Filter') }}</button>
                <a href="{{ url_for('main.home') }}" class="btn btn-secondary">{{ _('Reset') }}</a>
            </div>
        </div>
    </form>

    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th>{{ _('Cover') }}</th>
                <th>{{ _('Title') }}</th>
                <th>{{ _('Author') }}</th>
                <th>{{ _('Genre') }}</th>
                <th>{{ _('Year') }}</th>
                <th>{{ _('Status') }}</th>
                <th>{{ _('Actions') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr onclick="window.location='{{ url_for('main.book_detail', book_id=book.id) }}';"
                style="cursor: pointer;">
                <td>
                    {% if book.cover %}
                    <img src="{{ url_for('static', filename='uploads/' + book.cover) }}"
                        alt="{{ _('Book cover %(title)s', title=book.title) }}">
                    {% else %}
                    <i class='bx bx-image'></i>
                    {% endif %}
                </td>
                <td>{{ book.title }}</td>
                <td>{{ book.authors|map(attribute='name')|join(', ') }}</td>
                <td>
                    {% if book.genres %}
                        {% for genre in book.genres %}
                            {{ _(genre.name) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        {{ _('No genres') }} {# Opcjonalnie: komunikat, jeśli brak gatunków #}
                    {% endif %}
                </td>
                <td>{{ book.year }}</td>
                <td>
                    {% if book.status == 'available' %}
                    <span class="badge bg-success">{{ _('Available') }}</span>
                    {% elif book.status == 'reserved' %}
                    <span class="badge bg-info">{{ _('Reserved') }}</span>
                    {% elif book.status == 'on_loan' %}
                    <span class="badge bg-warning text-dark">{{ _('On Loan') }}</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ book.status.replace('_', ' ').title() }}</span>
                    {% endif %}
                </td>

                <td class="text-nowrap">
                    <form action="{{ url_for('main.add_favorite', book_id=book.id) }}" method="POST"
                        style="display: inline;">
                        <button type="submit" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip"
                            data-bs-placement="top" title="{{ _('Add to favorites') }}">
                            <i class='bx bx-heart'></i>
                        </button>
                    </form>
                    {% if book.status == 'available' %}
                    <a href="{{ url_for('main.request_reservation', book_id=book.id, user_id=current_user.id) }}"
                        class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="{{ _('Request Reservation') }}"><i class="bx bx-file"></i></a>
                    {% else %}
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled data-bs-toggle="tooltip"
                        data-bs-placement="top" title="{{ _('Book not available for reservation') }}"><i
                            class="bx bx-block"></i></button>
                    {% endif %}

                    {% if current_user and current_user.is_admin %}
                    <a href="{{ url_for('main.book_edit', book_id=book.id)}}" class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="{{ _('Edit Book') }}"><i
                            class="bx bx-edit"></i></a>
                    <a href="{{ url_for('main.book_delete', book_id=book.id)}}" class="btn btn-outline-danger btn-sm"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="{{ _('Delete Book') }}"><i
                            class="bx bx-trash"></i></a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if current_user and current_user.is_admin %}
    <a href="{{ url_for('main.book_add') }}" class="btn btn-primary add-book-btn">{{ _('Add book') }}
    </a>
    {% endif %}
</div>
{% endblock %}