{% extends "layout.html" %}
{% block content %}

<div class="container-xxl">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="book-count-card">
        <i class='bx bxs-info-circle'></i>
        <p class="mb-0">
            {% set n = books|length %}
            {{ ngettext('Library currently has %(n)s book.', 'Library currently has %(n)s books.', n, n=n) }}
        </p>
    </div>

    <h2>{{ _('List of books') }}</h2>

    <!-- Filtering form -->
    <form method="GET" action="{{ url_for('main.home') }}" class="mb-3">
        <div class="row g-2">
            <div class="col-md-2">
                <label for="title" class="form-label">{{ _('Title') }}</label>
                <input type="text" class="form-control" id="title" name="title"
                    value="{{ request.args.get('title', '') }}" placeholder="{{ _('Enter title to search') }}">
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label">{{ _('Status') }}</label>
                <select class="form-select" id="status" name="status">
                    <option value="">{{ _('All') }}</option>
                    <option value="available" {% if request.args.get('status')=='available' %}selected{% endif %}>{{
                        _('Available') }}</option>
                    <option value="on_loan" {% if request.args.get('status')=='on_loan' %}selected{% endif %}>{{ _('On
                        Loan/Reserved') }}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="genre" class="form-label">{{ _('Genre') }}</label>
                <select class="form-select" id="genre" name="genre">
                    <option value="">{{ _('All') }}</option>
                    {% for genre in genres %}
                    <option value="{{ genre.id }}" {% if request.args.get('genre')==genre.id|string %}selected{% endif
                        %}>{{ _(genre.name) }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="sort_by" class="form-label">{{ _('Sort by') }}</label>
                <select class="form-select" id="sort_by" name="sort_by">
                    <option value="title" {% if request.args.get('sort_by','title')=='title' %}selected{% endif %}>{{
                        _('Title A-Z') }}</option>
                    <option value="title_desc" {% if request.args.get('sort_by')=='title_desc' %}selected{% endif %}>{{
                        _('Title Z-A') }}</option>
                    <option value="year" {% if request.args.get('sort_by')=='year' %}selected{% endif %}>{{ _('Year (Oldest)') }}</option>
                    <option value="year_desc" {% if request.args.get('sort_by')=='year_desc' %}selected{% endif %}>{{
                        _('Year (Newest)') }}</option>
                </select>
            </div>
            <div class="col-md-4 buttons-container">
                <button type="submit" class="btn btn-primary me-2">{{ _('Filter') }}</button>
                <a href="{{ url_for('main.home') }}" class="btn btn-secondary">{{ _('Reset') }}</a>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>{{ _('Cover') }}</th>
                    <th>{{ _('Title') }}</th>
                    <th>{{ _('Author') }}</th>
                    <th>{{ _('Genre') }}</th>
                    <th>{{ _('Year') }}</th>
                    <th>{{ _('Library') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr onclick="window.location='{{ url_for('books.book_detail', book_id=book.id) }}';"
                    style="cursor: pointer;">
                    <td>
                        {% if book.cover %}
                        <img src="{{ url_for('static', filename='uploads/' + book.cover) }}"
                            alt="{{ _('Book cover %(title)s', title=book.title) }}">
                        {% else %}
                        <i class='bx bx-image'></i>
                        {% endif %}
                    </td>
                    <td>{{ book.title }}</td>
                    <td>{{ book.authors|map(attribute='name')|join(', ') }}</td>
                    <td>
                        {% if book.genres %}
                        {% for genre in book.genres %}
                        {{ _(genre.name) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% else %}
                        {{ _('No genres') }}
                        {% endif %}
                    </td>
                    <td>{{ book.year }}</td>
                    <td>{{ book.library.name }}</td>
                    <td>
                        {% if book.status == 'available' %}
                        <span class="badge bg-success">{{ _('Available') }}</span>
                        {% elif book.status == 'reserved' %}
                        <span class="badge bg-info">{{ _('Reserved') }}</span>
                        {% elif book.status == 'on_loan' %}
                        <span class="badge bg-warning text-dark">{{ _('On Loan') }}</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ book.status.replace('_', ' ').title() }}</span>
                        {% endif %}
                    </td>

                    <td>
                        <form action="{{ url_for('books.add_favorite', book_id=book.id) }}" method="POST"
                            style="display: inline-block; margin-bottom: 0.25rem;">
                            <button type="submit" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip"
                                data-bs-placement="top" title="{{ _('Add to favorites') }}">
                                <i class='bx bx-heart'></i>
                            </button>
                        </form>
                        {% if book.status == 'available' %}
                        <a href="{{ url_for('loans.request_reservation', book_id=book.id, user_id=current_user.id) }}"
                            class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ _('Request Reservation') }}" style="margin-bottom: 0.25rem;"><i
                                class="bx bx-file"></i></a>
                        {% else %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" disabled data-bs-toggle="tooltip"
                            data-bs-placement="top" title="{{ _('Book not available for reservation') }}"
                            style="margin-bottom: 0.25rem;"><i class="bx bx-block"></i></button>
                        {% endif %}

                        {% if current_user and current_user.role == 'admin' %}
                        <a href="{{ url_for('books.book_edit', book_id=book.id)}}" class="btn btn-outline-primary btn-sm"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="{{ _('Edit Book') }}"
                            style="margin-bottom: 0.25rem;"><i class="bx bx-edit"></i></a>
                        <a href="{{ url_for('books.book_delete', book_id=book.id)}}"
                            class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ _('Delete Book') }}" style="margin-bottom: 0.25rem;"><i
                                class="bx bx-trash"></i></a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if current_user and (current_user.role == 'admin' or current_user.role == 'manager') %}
    <a href="{{ url_for('books.book_add') }}" class="btn btn-primary add-book-btn">{{ _('Add book') }}
    </a>
    {% endif %}
</div>
{% endblock %}