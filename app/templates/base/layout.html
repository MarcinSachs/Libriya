{% import 'base/macros.html' as macros %}
<!DOCTYPE html>
<html lang="{% if request.cookies.get('language') in config.LANGUAGES %}{{ request.cookies.get('language') }}{% elif session.get('language') in config.LANGUAGES %}{{ session.get('language') }}{% else %}en{% endif %}">

            right: 20px;
            background: #0d6efd;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 1031;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        #update-banner.show {
            display: flex !important;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(120%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        #reload-app-btn {
            background: white;
            color: #0d6efd;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-left: 1rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        #reload-app-btn:hover {
            background: #f0f0f0;
        }
        
        #install-app-btn {
            display: none;
        }
    </style>
</head>

<body class="font-sans text-text-dark bg-gray-bg {% if login_page %}login-page{% endif %}" {% if current_user.is_authenticated %}data-user-logged-in="true"{% endif %}>
    <!-- Offline warning banner -->
    <div id="offline-warning" class="hidden fixed top-0 left-0 right-0 bg-yellow-100 border-b-2 border-yellow-500 px-4 py-3 flex justify-between items-center z-[1030]">
        <span><strong>⚠️ {{ _('You are offline') }}</strong> - {{ _('Some features may not work') }}</span>
        <button type="button" class="text-yellow-600 hover:text-yellow-800 text-lg font-bold" onclick="this.parentElement.classList.remove('show')">&times;</button>
    </div>

    <!-- Update available banner -->
    <div id="update-banner" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white px-6 py-4 rounded-lg flex justify-between items-center z-[1031] shadow-lg">
        <span>✨ {{ _('New version available!') }}</span>
        <button id="reload-app-btn" class="ml-4 bg-white text-blue-600 px-4 py-2 rounded font-semibold text-sm hover:bg-gray-100">{{ _('Reload') }}</button>
    </div>

    <!-- Navigation -->
    {% if not landing_page %}
    <nav id="navbar" class="{% if login_page %}bg-white border-b border-gray-200{% else %}glass-nav{% endif %} fixed w-full top-0 z-50 shadow-sm transition-shadow duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="/" class="flex items-center gap-2">
                        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Libriya" class="w-10 h-10">
                        <span class="text-3xl font-bold {% if login_page %}text-text-dark{% else %}text-primary{% endif %} hidden sm:block">Libriya</span>
                    </a>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center gap-8">
                    <!-- Online/Offline Status -->
                    <div id="online-status-badge" class="hidden">
                        <span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm flex items-center gap-1">
                            <i class="bx bx-wifi text-sm"></i> Online
                        </span>
                    </div>

                    <!-- Install App Button -->
                    {% if current_user.is_authenticated %}
                    {% if current_user.is_authenticated %}
                    <button id="install-app-btn" onclick="window.pwaManager && window.pwaManager.installApp()" class="px-3 py-2 border {% if login_page %}border-text-dark text-text-dark hover:bg-text-dark hover:text-white{% else %}border-white text-white hover:bg-white hover:text-primary{% endif %} rounded transition" style="display: none;">
                        <i class="bx bx-download"></i> {{ _('Install App') }}
                    </button>
                    {% endif %}
                    {% endif %}

                    {% if current_user.is_authenticated %}
                    <!-- User Dropdown -->
                    <div class="relative group pb-2">
                        <button class="flex items-center gap-2 {% if login_page %}text-text-dark{% else %}text-primary{% endif %} hover:text-accent transition">
                            <img class="w-8 h-8 rounded-full object-cover" 
                                src="{{ url_for('static', filename='uploads/' + current_user.image_file) }}" 
                                alt="{{ current_user.username }}">
                            <span class="text-sm font-medium">{{ current_user.username }}</span>
                            {% if unread_notifications_count and unread_notifications_count > 0 %}
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                {{ unread_notifications_count }}
                            </span>
                            {% endif %}
                        </button>
                        <div class="absolute right-0 top-full mt-0 w-48 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition">
                            <a href="{{ url_for('main.view_notifications') }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark first:rounded-t-lg">
                                <i class="bx bx-bell align-middle me-2"></i>{{ _('Notifications') }}
                                {% if unread_notifications_count and unread_notifications_count > 0 %}
                                <span class="float-right bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ unread_notifications_count }}</span>
                                {% endif %}
                            </a>
                            <a href="{{ url_for('users.user_profile', user_id=current_user.id) }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark">
                                <i class="bx bx-user-circle align-middle me-2"></i>{{ _('Profile & Loans') }}
                            </a>
                            <a href="{{ url_for('users.user_settings') }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark">
                                <i class="bx bx-cog align-middle me-2"></i>{{ _('Settings') }}
                            </a>
                            <a href="{{ url_for('main.my_messages') }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark">
                                <i class="bx bx-envelope align-middle me-2"></i>{{ _('Messages') }}
                            </a>
                            <hr class="my-1">
                            <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark last:rounded-b-lg">
                                <i class="bx bx-log-out align-middle me-2"></i>{{ _('Logout') }}
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}" class="{% if login_page %}text-text-dark{% else %}text-primary{% endif %} hover:text-accent transition font-medium">{{ _('Log In') }}</a>
                    {% endif %}

                    <!-- Language Selector -->
                    <div class="relative group pb-2">
                        <button class="flex items-center gap-1 {% if login_page %}text-text-dark{% else %}text-primary{% endif %} hover:text-accent transition">
                            <i class="bx bx-globe"></i>
                            <span class="text-sm font-medium">{{ _('Language') }}</span>
                        </button>
                        <div class="absolute right-0 top-full mt-0 w-40 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition">
                            <a href="{{ url_for('main.set_language', lang='en') }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark first:rounded-t-lg">
                                <span class="fi fi-gb me-2"></span> English
                            </a>
                            <a href="{{ url_for('main.set_language', lang='pl') }}" class="block px-4 py-2 hover:bg-gray-bg text-text-dark last:rounded-b-lg">
                                <span class="fi fi-pl me-2"></span> Polski
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 rounded hover:bg-gray-100">
                    <i class="bx bx-menu text-2xl {% if login_page %}text-text-dark{% else %}text-primary{% endif %}"></i>
                </button>
            </div>
        </div>
    </nav>
    {% endif %}

    <div class="flex pt-16">
        {% if not login_page and not landing_page %}
        <!-- Sidebar - Hidden on Mobile -->
        <aside id="sidebar" class="hidden md:flex md:w-64 bg-white border-r border-gray-200 flex-col py-6 px-4 fixed left-0 top-16 h-[calc(100vh-64px)] overflow-y-auto">
            ...existing code...
        </aside>
        {% endif %}

        <!-- Main Content -->
        <main class="w-full {% if login_page %}flex items-center justify-center{% elif not landing_page %}md:ml-64{% endif %} min-h-[calc(100vh-64px)]">
            {% if login_page %}
            <div class="w-full max-w-md px-4">
            {% elif not landing_page %}
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            {% endif %}
                {% block content %}{% endblock %}
            {% if not landing_page %}</div>{% endif %}
        </main>
    </div>

    {# Footer removed: now provided by main_base.html #}

    <!-- PWA configuration injected from backend -->
    <script>
        window.pwaConfig = {
            cacheVersion: '{{ PWA_CACHE_VERSION }}',
            precachePages: {{ PWA_PRECACHE_PAGES|tojson }},
            updateInterval: {{ PWA_UPDATE_INTERVAL }},
            currentUserId: {{ PWA_CURRENT_USER_ID|default(none)|tojson }}
        };
    </script>

    <!-- Load PWA manager as an ES module (makes it easier to split logic) -->
    <script type="module">
        import PWAManager from '{{ url_for('static', filename='js/pwa-manager.js') }}?v={{ PWA_CACHE_VERSION }}';
        window.pwaManager = new PWAManager();
    </script>

    <!-- Load offline data manager for displaying cached books -->
    <script src="{{ url_for('static', filename='js/offline-data.js') }}"></script>

    <script>
        // Auto-cache offline data after login (if online and first time)
        if (document.body.hasAttribute('data-user-logged-in')) {
            document.addEventListener('DOMContentLoaded', function() {
                // Wait for PWA manager to be ready
                const checkPWAReady = setInterval(function() {
                    if (window.pwaManager && navigator.onLine) {
                        clearInterval(checkPWAReady);
                        
                        // Check if this is first login (no offline cache info)
                        const offlineCacheInfo = localStorage.getItem('offlineCacheInfo');
                        
                        // Auto-cache if:
                        // 1. Device is online
                        // 2. User hasn't cached offline data yet OR cache is older than 7 days
                        if (!offlineCacheInfo) {
                            console.log('[Auto-Cache] First login - attempting to cache offline data...');
                            
                            // Schedule for after page fully loads
                            setTimeout(async function() {
                                try {
                                    await window.pwaManager.preCacheOfflineData(false);
                                    console.log('[Auto-Cache] Offline data cached successfully');
                                } catch (e) {
                                    console.log('[Auto-Cache] Failed to cache (non-critical):', e.message);
                                }
                            }, 2000);
                        } else {
                            // Check if cache is older than 7 days
                            try {
                                const cacheInfo = JSON.parse(offlineCacheInfo);
                                const lastCacheDate = new Date(cacheInfo.timestamp);
                                const daysSinceCache = (new Date() - lastCacheDate) / (1000 * 60 * 60 * 24);
                                
                                if (daysSinceCache > 7) {
                                    console.log('[Auto-Cache] Cache older than 7 days - refreshing...');
                                    setTimeout(async function() {
                                        try {
                                            await window.pwaManager.preCacheOfflineData(false);
                                            console.log('[Auto-Cache] Offline data refreshed');
                                        } catch (e) {
                                            console.log('[Auto-Cache] Failed to refresh cache:', e.message);
                                        }
                                    }, 2000);
                                }
                            } catch (e) {
                                console.log('[Auto-Cache] Error checking cache age:', e);
                            }
                        }
                    }
                }, 100);
                
                // Clear interval after 5 seconds if PWA manager not ready
                setTimeout(function() { clearInterval(checkPWAReady); }, 5000);
            });
        }
    </script>

    <script>
        console.log('Layout script started');
        
        // Check if delete buttons exist
        const deleteButtons = document.querySelectorAll('.delete-btn');
        console.log('Delete buttons found:', deleteButtons.length);
        deleteButtons.forEach((btn, idx) => {
            console.log(`Delete button ${idx}:`, btn, 'data-book-id:', btn.getAttribute('data-book-id'));
        });
        
        // Admin menu toggle
        const adminToggle = document.getElementById('admin-toggle');
        const adminMenu = document.getElementById('admin-menu');
        if (adminToggle && adminMenu) {
            adminToggle.addEventListener('click', () => {
                adminMenu.classList.toggle('hidden');
                const icon = adminToggle.querySelector('i:last-child');
                icon.classList.toggle('rotate-180');
            });
        }

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        console.log('[MENU] Mobile menu button:', mobileMenuBtn);
        console.log('[MENU] Sidebar:', sidebar);
        if (mobileMenuBtn && sidebar) {
            mobileMenuBtn.addEventListener('click', () => {
                console.log('[MENU] Hamburger clicked!');
                sidebar.classList.toggle('hidden');
            });

            // Close sidebar when clicking a link
            sidebar.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    sidebar.classList.add('hidden');
                });
            });
        } else {
            console.warn('[MENU] Mobile menu not initialized - mobileMenuBtn or sidebar is null');
        }

        // Service worker registration is handled by pwa-manager.js module above
        // (avoids duplicate fetches and allows dynamic path configuration)

        // Handle delete button clicks (with event delegation for dynamic elements)
        console.log('Adding delete button event listener to document');
        document.addEventListener('click', function(e) {
            console.log('Document click detected on:', e.target, 'Classes:', e.target.className);
            if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                console.log('Delete button handler triggered!');
                const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
                console.log('Delete button clicked');
                e.preventDefault();
                const bookId = btn.getAttribute('data-book-id');
                console.log('Book ID:', bookId);
                
                if (confirm(`{{ _('Are you sure you want to delete this book?') }}`)) {
                    console.log('Confirmed delete for book:', bookId);
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    console.log('CSRF token found:', !!csrfToken);
                    
                    // Use fetch API to send DELETE request
                    fetch(`/book_delete/${bookId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken || ''
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (response.ok) {
                            console.log('Delete successful');
                            window.location.href = '/';
                        } else {
                            console.error('Delete failed:', response.statusText);
                            alert('Error deleting book');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('Error deleting book: ' + error);
                    });
                } else {
                    console.log('Delete cancelled');
                }
            }
        });

        // Offline status
        window.addEventListener('offline', () => {
            document.getElementById('offline-warning').classList.add('show');
        });

        window.addEventListener('online', () => {
            document.getElementById('offline-warning').classList.remove('show');
        });

        // Navbar scroll shadow effect
        const navbar = document.getElementById('navbar');
        if (navbar) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 0) {
                    navbar.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                } else {
                    navbar.style.boxShadow = 'none';
                }
            });
        }
    </script>
</body>

</html>