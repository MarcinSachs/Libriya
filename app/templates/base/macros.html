{# Unified Alert Messages #}
{% macro alert(message, category='info', dismissible=True) %}
<div class="{% if category == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif category == 'error' or category == 'danger' %}bg-red-50 border border-red-200 text-red-800{% elif category == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %} px-4 py-3 rounded-lg flex items-start gap-2" role="alert">
    <div class="flex-1 flex items-start gap-2">
        {% if category == 'success' %}
        <i class='bx bx-check-circle mt-0.5'></i>
        {% elif category == 'danger' or category == 'error' %}
        <i class='bx bx-error-circle mt-0.5'></i>
        {% elif category == 'warning' %}
        <i class='bx bx-alert-triangle mt-0.5'></i>
        {% else %}
        <i class='bx bx-info-circle mt-0.5'></i>
        {% endif %}
        <span>{{ message }}</span>
    </div>
    {% if dismissible %}
    <button type="button" class="text-current hover:opacity-70 transition" onclick="this.parentElement.remove()" aria-label="Close">
        <i class='bx bx-x'></i>
    </button>
    {% endif %}
</div>
{% endmacro %}

{# Unified Flash Messages Display #}
{% macro display_flashes() %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="mb-4 space-y-2">
    {% for category, message in messages %}
    {{ alert(message, category, True) }}
    {% endfor %}
</div>
{% endif %}
{% endwith %}
{% endmacro %}

{# Unified Form Field with Errors #}
{% macro form_field(field, field_type='text', icon=None, label_icon=None, placeholder=None, help_text=None, class='mb-3', size=None, readonly=false) %}
<div class="{{ class }}">
    {% if field.type != 'HiddenField' %}
    <label class="block font-medium text-gray-700 mb-2" for="{{ field.id }}">
        {{ field.label.text }}
        {% if field.flags.required %}
        <span class="text-red-500">*</span>
        {% endif %}
    </label>
    {% endif %}

    {% if field_type == 'file' %}
    <!-- Custom file input styling -->
    <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-[#4ecdc4]">
        {% if icon %}
        <span class="px-3 py-2 flex items-center justify-center text-gray-600">
            <i class='bx {{ icon }}'></i>
        </span>
        {% endif %}
        {{ field(class='hidden', accept='image/*') }}
        <label class="flex-1 px-4 py-2 bg-white cursor-pointer hover:bg-gray-50 transition" for="{{ field.id }}">
            {{ _('Browse...') }}
        </label>
    </div>
    <small class="text-gray-600 block mt-1" id="{{ field.id }}-status">{{ _('No file selected') }}</small>
    <script>
        (function() {
            let fileInput = document.getElementById('{{ field.id }}');
            let statusLabel = document.getElementById('{{ field.id }}-status');
            let noFileText = "{{ _('No file selected') }}";
            
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    statusLabel.textContent = this.files[0].name;
                } else {
                    statusLabel.textContent = noFileText;
                }
            });
        })();
    </script>
    {% else %}
    <div class="flex items-center bg-white border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-[#4ecdc4]">
        {% if icon %}
        <span class="px-3 py-2 flex items-center justify-center text-gray-600">
            <i class='bx {{ icon }}'></i>
        </span>
        {% endif %}
        {% if field_type == 'textarea' %}
        {{ field(class='flex-1 px-4 py-2 bg-white focus:outline-none appearance-none' + (' border-red-500' if field.errors else ''), placeholder=placeholder or '', rows='8', style='height:200px; resize: vertical; background-color: white;') }}
        {% elif field_type == 'select' %}
        {{ field(class='flex-1 px-4 py-2 bg-white focus:outline-none appearance-none' + (' border-red-500' if field.errors else ''), style='background-color: white;') }}
        {% else %}
        {{ field(class='flex-1 px-4 py-2 bg-white focus:outline-none' + (' border-red-500' if field.errors else ''), placeholder=placeholder or '', type=field_type, readonly=readonly) }}
        {% endif %}
    </div>
    {% endif %}
    
    {% if field.errors %}
    <div class="text-red-500 text-sm mt-1">
        {% for error in field.errors %}
        <div><i class='bx bx-error-circle align-middle'></i> {{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if help_text %}
    <small class="text-gray-600 block mt-1">{{ help_text }}</small>
    {% endif %}
</div>
{% endmacro %}

{# Unified Form Submit Button #}
{% macro form_submit(button_text, color='primary', icon='bx-check', full_width=False, cancel_url=None) %}
<div class="{% if full_width %}w-full{% else %}flex gap-3{% endif %}">
    <button type="submit" class="btn {% if color == 'success' %}btn-success{% elif color == 'danger' %}btn-danger{% else %}btn-primary{% endif %} {% if full_width %}w-full{% endif %}">
        <i class='bx {{ icon }} align-middle'></i> {{ button_text }}
    </button>
    {% if cancel_url %}
    <a href="{{ cancel_url }}" class="btn btn-outline {% if full_width %}w-full text-center{% endif %}" role="button">
        <i class='bx bx-x align-middle'></i> {{ _('Cancel') }}
    </a>
    {% endif %}
</div>
{% endmacro %}

{# Unified Action Button #}
{% macro action_button(url, text, color='primary', icon='bx-pencil', size='sm', full_width=False) %}
<a href="{{ url }}" class="btn {% if color == 'primary' %}btn-primary{% elif color == 'danger' %}btn-danger{% else %}btn-outline{% endif %} {% if size == 'sm' %}btn-sm{% endif %} {% if full_width %}w-full text-center{% endif %}" title="{{ text }}">
    <i class='bx {{ icon }} align-middle'></i> {{ text }}
</a>
{% endmacro %}

{# Unified Card Header #}
{% macro card_header(title, icon=None, color='light') %}
<div class="{% if color == 'primary' %}bg-gradient-to-r from-[#1a535c] to-[#4ecdc4] text-white{% else %}bg-gray-100{% endif %} px-4 py-3 border-b border-gray-200">
    <h5 class="font-semibold">
        {% if icon %}
        <i class='bx {{ icon }} align-middle mr-2'></i>
        {% endif %}
        {{ title }}
    </h5>
</div>
{% endmacro %}

{# Unified Section Card #}
{% macro section_card(title, icon=None, color='light') %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
    {{ card_header(title, icon, color) }}
    <div class="px-4 py-3">
        {{ caller() }}
    </div>
</div>
{% endmacro %}
