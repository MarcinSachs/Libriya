{% extends "layout.html" %}
{% block content %}
<div class="container">
    <h2>{{ _('My Settings') }}</h2> 
    <hr>

    {{ macros.display_flashes() }}

    <form method="POST" action="" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group mb-3"> 
            <label class="form-label">{{ _('Current Profile Picture') }}</label> 
            <div>
                <img class="rounded-circle" src="{{ url_for('static', filename='uploads/' + user.image_file) }}"
                    style="width: 150px; height: 150px; object-fit: cover;">
            </div>
        </div>
        <div class="form-group mb-3"> 
            {{ form.picture.label(class="form-label") }} 
            {{ form.picture(class="form-control") }}
            {% for error in form.picture.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
        </div>
        <div class="form-group mb-3"> 
            {{ form.email.label(class="form-label") }} 
            {{ form.email(class="form-control") }}
            {% for error in form.email.errors %}<span class="text-danger">{{ error }}</span>{% endfor %} 
        </div>
        <p class="text-muted">{{ _('Leave the password fields blank if you don\'t want to change your password.') }}</p>
        
        <div class="form-group mb-3"> 
            {{ form.password.label(class="form-label") }} 
            {{ form.password(class="form-control") }}
            {% for error in form.password.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
        </div>
        <div class="form-group mb-3"> 
            {{ form.confirm_password.label(class="form-label") }} 
            {{ form.confirm_password(class="form-control") }}
            {% for error in form.confirm_password.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
        </div>
        <div class="mt-4 d-flex align-items-center gap-2"> 
            {{ form.submit(class="btn btn-primary") }} 
            <a href="{{ url_for('users.user_profile', user_id=current_user.id) }}" class="btn btn-secondary">
                </i> {{ _('Cancel') }} 
            </a> 
        </div>
    </form>

    <!-- Offline Mode Section -->
    <hr class="my-4">
    <h4><i class='bx bx-wifi-off'></i> {{ _('Offline Mode') }}</h4>
    <p class="text-muted">{{ _('Download all your books and covers for offline access.') }}</p>
    
    <div class="card">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-1">{{ _('Offline Library') }}</h5>
                    <p class="text-muted small mb-2" id="offline-cache-status">{{ _('Loading status...') }}</p>
                    <p class="small mb-0" id="offline-cache-progress"></p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <button type="button" class="btn btn-primary" id="download-offline-btn" onclick="downloadOfflineData()">
                        <i class='bx bx-download'></i> {{ _('Download') }}
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm ms-2" id="clear-offline-btn" onclick="clearOfflineData()">
                        <i class='bx bx-trash'></i>
                    </button>
                </div>
            </div>
            
            <!-- Size estimation -->
            <div class="mt-3 small">
                <div class="d-flex justify-content-between text-muted">
                    <span><i class='bx bx-data'></i> {{ _('Book data') }}:</span>
                    <span id="data-size">~2 KB/{{ _('book') }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted">
                    <span><i class='bx bx-image'></i> {{ _('Micro covers') }}:</span>
                    <span id="cover-size">~3 KB/{{ _('book') }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted">
                    <span><i class='bx bx-file'></i> {{ _('Detail pages') }}:</span>
                    <span id="page-size">~15 KB/{{ _('book') }}</span>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between fw-bold">
                    <span>{{ _('Estimated total') }}:</span>
                    <span id="total-size">~20 KB/{{ _('book') }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update offline cache status on page load
document.addEventListener('DOMContentLoaded', async function() {
    if (window.pwaManager) {
        const status = await window.pwaManager.getOfflineCacheStatus();
        const statusEl = document.getElementById('offline-cache-status');
        
        if (status.lastCache && status.lastCache.success) {
            const date = new Date(status.lastCache.timestamp).toLocaleDateString();
            statusEl.innerHTML = `<span class="text-success"><i class='bx bx-check-circle'></i> {{ _('Last download') }}: ${date}</span><br>` +
                `üìö ${status.lastCache.booksCount} {{ _('books') }}, üñºÔ∏è ${status.lastCache.coversCount} {{ _('covers') }}`;
        } else {
            statusEl.innerHTML = `<span class="text-warning"><i class='bx bx-info-circle'></i> {{ _('Not downloaded yet') }}</span>`;
        }
    }
});

async function downloadOfflineData() {
    const btn = document.getElementById('download-offline-btn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> {{ _("Downloading...") }}';
    
    try {
        const result = await window.pwaManager.preCacheOfflineData(true);
        
        if (result.success) {
            const statusEl = document.getElementById('offline-cache-status');
            statusEl.innerHTML = `<span class="text-success"><i class='bx bx-check-circle'></i> {{ _('Download complete!') }}</span><br>` +
                `üìö ${result.booksCount} {{ _('books') }}, üñºÔ∏è ${result.coversCount} {{ _('covers') }}`;
        }
    } catch (e) {
        console.error('Download error:', e);
    }
    
    btn.disabled = false;
    btn.innerHTML = originalText;
}

async function clearOfflineData() {
    if (confirm('{{ _("Are you sure you want to clear offline data?") }}')) {
        await window.pwaManager.clearOfflineData();
        document.getElementById('offline-cache-status').innerHTML = 
            `<span class="text-warning"><i class='bx bx-info-circle'></i> {{ _('Not downloaded yet') }}</span>`;
        document.getElementById('offline-cache-progress').textContent = '{{ _("Cache cleared") }}';
    }
}
</script>
{% endblock %}